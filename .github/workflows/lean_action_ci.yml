name: Lean Action CI

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  HF_DATASET_NAME: my-dataset

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      - uses: leanprover/lean-action@v1

      - name: Install uv
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: astral-sh/setup-uv@v4

      - name: Verify HF authentication
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          AUTH_OUTPUT=$(uvx hf auth whoami 2>&1)
          if echo "$AUTH_OUTPUT" | grep -q "Not logged in"; then
            echo "::error::HuggingFace authentication failed. Please ensure HF_TOKEN secret is set and valid."
            exit 1
          fi
          echo "Successfully authenticated with HuggingFace"

      - name: Get HF username
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: hf-user
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          username=$(uvx hf auth whoami | grep -oP 'User:\s*\K\S+' | tr -d '\n\r')
          echo "Extracted username: '$username'"
          echo "username=$username" >> "$GITHUB_OUTPUT"

      - name: Create temp directory
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: tempdir
        run: echo "path=$(mktemp -d)" >> "$GITHUB_OUTPUT"

      - name: Generate parquet files
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          curl -fsSL https://raw.githubusercontent.com/mathlib-initiative/lean_scout/main/extract.sh \
            | bash -s -- \
                --command types \
                --parquet \
                --dataDir "${{ steps.tempdir.outputs.path }}" \
                --imports Lean

      - name: Verify parquet files exist
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          if ! ls "${{ steps.tempdir.outputs.path }}"/*.parquet 1>/dev/null 2>&1; then
            echo "::error::No parquet files were generated"
            exit 1
          fi
          echo "Generated parquet files:"
          ls -lh "${{ steps.tempdir.outputs.path }}"/*.parquet

      - name: Upload to HuggingFace Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          REPO_ID="${{ steps.hf-user.outputs.username }}/${{ env.HF_DATASET_NAME }}"
          echo "Uploading to repo: '$REPO_ID'"
          uvx hf upload \
            "$REPO_ID" \
            "${{ steps.tempdir.outputs.path }}" \
            --repo-type dataset \
            --private \
            --commit-message "Update dataset from ${{ github.sha }}"
