name: Upload to HuggingFace Hub

on:
  workflow_run:
    workflows: ["Lean Action CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DATASET_NAME: my-dataset

jobs:
  upload:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Verify HF authentication
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          AUTH_OUTPUT=$(uvx hf auth whoami 2>&1)
          if echo "$AUTH_OUTPUT" | grep -q "Not logged in"; then
            echo "::error::HuggingFace authentication failed. Please ensure HF_TOKEN secret is set and valid."
            exit 1
          fi
          echo "Successfully authenticated with HuggingFace"

      - name: Get HF username
        id: hf-user
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          username=$(uvx hf auth whoami | awk -F: '{print $2}' | tr -d ' ')
          echo "username=$username" >> "$GITHUB_OUTPUT"

      - name: Create temp directory
        id: tempdir
        run: echo "path=$(mktemp -d)" >> "$GITHUB_OUTPUT"

      - name: Generate parquet files
        run: |
          curl -fsSL https://raw.githubusercontent.com/mathlib-initiative/lean_scout/main/extract.sh \
            | bash -s -- \
                --command types \
                --parquet \
                --outDir "${{ steps.tempdir.outputs.path }}" \
                --imports Lean

      - name: Verify parquet files exist
        run: |
          if ! ls "${{ steps.tempdir.outputs.path }}"/*.parquet 1>/dev/null 2>&1; then
            echo "::error::No parquet files were generated"
            exit 1
          fi
          echo "Generated parquet files:"
          ls -lh "${{ steps.tempdir.outputs.path }}"/*.parquet

      - name: Upload to HuggingFace Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          uvx hf upload \
            "${{ steps.hf-user.outputs.username }}/${{ env.DATASET_NAME }}" \
            "${{ steps.tempdir.outputs.path }}" \
            --repo-type dataset \
            --private \
            --revision "${{ github.sha }}" \
            --commit-message "Update dataset from ${{ github.sha }}"